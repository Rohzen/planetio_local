<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- ========================================== -->
        <!-- EUDR LOT VIEWS -->
        <!-- ========================================== -->

        <record id="view_eudr_lot_tree" model="ir.ui.view">
            <field name="name">eudr.lot.tree</field>
            <field name="model">eudr.lot</field>
            <field name="arch" type="xml">
                <tree string="EUDR Lots"
                      decoration-success="state == 'compliant'"
                      decoration-info="state == 'ready'"
                      decoration-warning="state == 'declared'"
                      decoration-muted="state == 'draft'">
                    <field name="name"/>
                    <field name="hs_code_id"/>
                    <field name="product_species_id" optional="show"/>
                    <field name="product_description" optional="hide"/>
                    <field name="net_mass_kg"/>
                    <field name="plot_count" string="Plots"/>
                    <field name="total_area_ha" string="Area (ha)" optional="show"/>
                    <field name="supplier_id" optional="hide"/>
                    <field name="activity_type" optional="hide"/>
                    <field name="declaration_count" string="DDS"/>
                    <field name="state" widget="badge" decoration-success="state == 'compliant'" decoration-info="state == 'ready'"/>
                    <field name="company_id" groups="base.group_multi_company" optional="hide"/>
                </tree>
            </field>
        </record>

        <record id="view_eudr_lot_form" model="ir.ui.view">
            <field name="name">eudr.lot.form</field>
            <field name="model">eudr.lot</field>
            <field name="arch" type="xml">
                <form string="EUDR Lot">
                    <header>
                        <button name="action_create_dds_declaration"
                                type="object"
                                string="Create DDS Declaration"
                                class="btn-primary"
                                attrs="{'invisible': ['|', ('state', 'in', ['declared', 'compliant']), ('is_assessment_only', '=', True)]}"/>
                        <button name="action_load_dds_data"
                                type="object"
                                string="Load DDS Data"
                                class="btn-secondary"
                                attrs="{'invisible': ['|', ('is_assessment_only', '=', False), ('reference_dds_identifier', '=', False)]}"/>
                        <button name="action_set_ready"
                                type="object"
                                string="Set Ready"
                                attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                        <button name="action_set_draft"
                                type="object"
                                string="Reset to Draft"
                                attrs="{'invisible': [('state', '=', 'draft')]}"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,ready,declared,compliant"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_declarations"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-file-text"
                                    attrs="{'invisible': [('declaration_count', '=', 0)]}">
                                <field name="declaration_count" widget="statinfo" string="Declarations"/>
                            </button>
                            <button name="action_view_plots"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-map-marker"
                                    attrs="{'invisible': [('plot_count', '=', 0)]}">
                                <field name="plot_count" widget="statinfo" string="Plots"/>
                            </button>
                        </div>

                        <widget name="web_ribbon" title="Assessment Only" bg_color="bg-info" attrs="{'invisible': [('is_assessment_only', '=', False)]}"/>

                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Lot Reference..."/>
                            </h1>
                        </div>

                        <group>
                            <group string="Product Information">
                                <field name="product_id"/>
                                <field name="stock_lot_id"/>
                                <field name="hs_code_id"/>
                                <field name="product_species_id" domain="[('hs_code_id', '=', hs_code_id)]" options="{'no_create': True}"/>
                                <field name="product_description"/>
                                <field name="net_mass_kg"/>
                            </group>
                            <group string="General Information">
                                <field name="activity_type"/>
                                <field name="supplier_id"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                                <field name="total_area_ha" string="Total Area (ha)" widget="float" digits="[16,4]"/>
                                <field name="active"/>
                            </group>
                        </group>

                        <group string="Assessment Mode" attrs="{'invisible': [('is_assessment_only', '=', False)]}">
                            <group>
                                <field name="is_assessment_only"/>
                                <field name="reference_dds_identifier"/>
                            </group>
                            <group>
                                <field name="reference_dds_number" readonly="1"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Plots/Locations">
                                <field name="plot_ids" context="{'default_company_id': company_id}">
                                    <tree editable="bottom">
                                        <field name="name"/>
                                        <field name="producer_id" domain="[('is_eudr_producer', '=', True)]"/>
                                        <field name="farm_name"/>
                                        <field name="country_id"/>
                                        <field name="region" optional="hide"/>
                                        <field name="municipality" optional="hide"/>
                                        <field name="geo_type"/>
                                        <field name="area_ha" string="Area (ha)"/>
                                        <button name="action_visualize_on_map" type="object" string="Map" icon="fa-globe" class="btn-link"/>
                                    </tree>
                                    <form>
                                        <sheet>
                                            <group>
                                                <group>
                                                    <field name="name"/>
                                                    <field name="producer_id" domain="[('is_eudr_producer', '=', True)]"/>
                                                    <field name="farm_name"/>
                                                </group>
                                                <group>
                                                    <field name="country_id"/>
                                                    <field name="region"/>
                                                    <field name="municipality"/>
                                                    <field name="geo_type"/>
                                                    <field name="area_ha"/>
                                                </group>
                                            </group>
                                            <group string="GeoJSON Geometry">
                                                <field name="geometry" widget="text" nolabel="1"/>
                                            </group>
                                            <group string="Notes">
                                                <field name="notes" nolabel="1"/>
                                            </group>
                                        </sheet>
                                    </form>
                                </field>
                            </page>

                            <page string="Declarations" attrs="{'invisible': [('declaration_count', '=', 0)]}">
                                <field name="declaration_ids" readonly="1">
                                    <tree>
                                        <field name="name"/>
                                        <field name="create_date"/>
                                        <field name="stage_id"/>
                                        <field name="eudr_id"/>
                                        <field name="net_mass_kg"/>
                                    </tree>
                                </field>
                            </page>

                            <page string="Notes">
                                <field name="notes" placeholder="Additional information..." nolabel="1"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <record id="view_eudr_lot_search" model="ir.ui.view">
            <field name="name">eudr.lot.search</field>
            <field name="model">eudr.lot</field>
            <field name="arch" type="xml">
                <search string="Search EUDR Lots">
                    <field name="name"/>
                    <field name="hs_code_id"/>
                    <field name="product_species_id"/>
                    <field name="supplier_id"/>
                    <field name="product_id"/>
                    <separator/>
                    <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Ready" name="ready" domain="[('state', '=', 'ready')]"/>
                    <filter string="Declared" name="declared" domain="[('state', '=', 'declared')]"/>
                    <filter string="Compliant" name="compliant" domain="[('state', '=', 'compliant')]"/>
                    <separator/>
                    <filter string="Assessment Only" name="assessment_only" domain="[('is_assessment_only', '=', True)]"/>
                    <separator/>
                    <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                    <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
                    <group expand="0" string="Group By">
                        <filter string="State" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="HS Code" name="group_hs_code" context="{'group_by': 'hs_code_id'}"/>
                        <filter string="Supplier" name="group_supplier" context="{'group_by': 'supplier_id'}"/>
                        <filter string="Activity Type" name="group_activity" context="{'group_by': 'activity_type'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action for EUDR Lot -->
        <record id="action_eudr_lot" model="ir.actions.act_window">
            <field name="name">EUDR Lots</field>
            <field name="res_model">eudr.lot</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first EUDR Lot
                </p>
                <p>
                    Manage lots/batches for EUDR compliance. Each lot can generate DDS declarations.
                </p>
            </field>
        </record>

        <!-- Menu under Planetio -->
        <menuitem id="menu_eudr_lots"
                  name="Lots"
                  parent="menu_eudr_ai_root"
                  action="action_eudr_lot"
                  sequence="10"/>


        <!-- ========================================== -->
        <!-- EUDR PLOT VIEWS -->
        <!-- ========================================== -->

        <record id="view_eudr_plot_tree" model="ir.ui.view">
            <field name="name">eudr.plot.tree</field>
            <field name="model">eudr.plot</field>
            <field name="arch" type="xml">
                <tree string="EUDR Plots">
                    <field name="name"/>
                    <field name="producer_id"/>
                    <field name="farm_name"/>
                    <field name="country_id"/>
                    <field name="region" optional="hide"/>
                    <field name="municipality" optional="hide"/>
                    <field name="geo_type"/>
                    <field name="area_ha" string="Area (ha)"/>
                    <field name="lot_count" string="Lots"/>
                    <field name="company_id" groups="base.group_multi_company" optional="hide"/>
                    <button name="action_visualize_on_map" type="object" string="" icon="fa-globe" class="btn-link" title="View on Map"/>
                </tree>
            </field>
        </record>

        <record id="view_eudr_plot_form" model="ir.ui.view">
            <field name="name">eudr.plot.form</field>
            <field name="model">eudr.plot</field>
            <field name="arch" type="xml">
                <form string="EUDR Plot">
                    <header>
                        <button name="action_visualize_on_map" type="object" string="View on Map" class="btn-primary" icon="fa-globe"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_lots"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-cubes"
                                    attrs="{'invisible': [('lot_count', '=', 0)]}">
                                <field name="lot_count" widget="statinfo" string="Lots"/>
                            </button>
                        </div>

                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Plot Reference..."/>
                            </h1>
                        </div>

                        <group>
                            <group string="Producer Information">
                                <field name="producer_id" domain="[('is_eudr_producer', '=', True)]"/>
                                <field name="farm_name"/>
                            </group>
                            <group string="Location">
                                <field name="country_id"/>
                                <field name="region"/>
                                <field name="municipality"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                            </group>
                        </group>

                        <group>
                            <group string="Geometry">
                                <field name="geo_type"/>
                                <field name="area_ha" widget="float" digits="[16,4]"/>
                            </group>
                            <group>
                                <field name="active"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="GeoJSON Geometry">
                                <field name="geometry" widget="text" placeholder='{"type": "Point", "coordinates": [longitude, latitude]}' nolabel="1"/>
                            </page>

                            <page string="Associated Lots" attrs="{'invisible': [('lot_count', '=', 0)]}">
                                <field name="lot_ids" readonly="1">
                                    <tree>
                                        <field name="name"/>
                                        <field name="hs_code_id"/>
                                        <field name="net_mass_kg"/>
                                        <field name="state"/>
                                    </tree>
                                </field>
                            </page>

                            <page string="Notes">
                                <field name="notes" placeholder="Additional information..." nolabel="1"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_eudr_plot_search" model="ir.ui.view">
            <field name="name">eudr.plot.search</field>
            <field name="model">eudr.plot</field>
            <field name="arch" type="xml">
                <search string="Search EUDR Plots">
                    <field name="name"/>
                    <field name="producer_id"/>
                    <field name="farm_name"/>
                    <field name="country_id"/>
                    <separator/>
                    <filter string="Points" name="points" domain="[('geo_type', '=', 'point')]"/>
                    <filter string="Polygons" name="polygons" domain="[('geo_type', '=', 'polygon')]"/>
                    <separator/>
                    <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                    <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
                    <group expand="0" string="Group By">
                        <filter string="Producer" name="group_producer" context="{'group_by': 'producer_id'}"/>
                        <filter string="Country" name="group_country" context="{'group_by': 'country_id'}"/>
                        <filter string="Geometry Type" name="group_geo_type" context="{'group_by': 'geo_type'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action for EUDR Plot -->
        <record id="action_eudr_plot" model="ir.actions.act_window">
            <field name="name">EUDR Plots</field>
            <field name="res_model">eudr.plot</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first EUDR Plot
                </p>
                <p>
                    Define plot/farm locations with GeoJSON geometries. Link plots to producers and lots.
                </p>
            </field>
        </record>

        <!-- Menu under Planetio -->
        <menuitem id="menu_eudr_plots"
                  name="Plots"
                  parent="menu_eudr_ai_root"
                  action="action_eudr_plot"
                  sequence="11"/>


        <!-- ========================================== -->
        <!-- RES.PARTNER EXTENSIONS -->
        <!-- ========================================== -->

        <record id="view_partner_form_eudr" model="ir.ui.view">
            <field name="name">res.partner.form.eudr</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_form"/>
            <field name="arch" type="xml">
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="action_view_eudr_plots"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-map-marker"
                            attrs="{'invisible': [('eudr_plot_count', '=', 0)]}">
                        <field name="eudr_plot_count" widget="statinfo" string="EUDR Plots"/>
                    </button>
                </xpath>

                <xpath expr="//page[@name='sales_purchases']" position="after">
                    <page string="EUDR Producer" attrs="{'invisible': [('is_eudr_producer', '=', False)]}">
                        <group>
                            <group>
                                <field name="is_eudr_producer"/>
                                <field name="farmer_id_code"/>
                            </group>
                        </group>
                        <field name="eudr_plot_ids" readonly="1">
                            <tree>
                                <field name="name"/>
                                <field name="farm_name"/>
                                <field name="country_id"/>
                                <field name="geo_type"/>
                                <field name="area_ha"/>
                                <field name="lot_count"/>
                            </tree>
                        </field>
                    </page>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
