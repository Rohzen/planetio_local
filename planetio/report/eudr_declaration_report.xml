<odoo>
    <data>

<template id="report_eudr_declaration_document">
    <t t-call="web.html_container">
        <!-- Styles kept simple for wkhtmltopdf compatibility -->
        <style type="text/css">
            .eudr-report * { box-sizing: border-box; }
            .eudr-report { font-size: 12px; color: #222; }
            .eudr-report h2, .eudr-report h3 {
                color: #2e7d32; /* green titles */
                margin: 0 0 8px 0;
                line-height: 1.2;
            }
            .eudr-report h2 { font-size: 20px; }
            .eudr-report h3 { font-size: 16px; margin-top: 18px; }

            .eudr-meta { margin-bottom: 10px; }
            .eudr-meta p { margin: 2px 0; }

            .eudr-card {
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 10px;
            }

            .eudr-table {
                width: 100%;
                border-collapse: collapse;
                margin: 8px 0 16px 0;
                table-layout: fixed;
            }
            .eudr-table th, .eudr-table td {
                border: 1px solid #999; /* 1px borders */
                padding: 6px 8px;
                vertical-align: top;
                word-wrap: break-word;
            }
            .eudr-table thead th {
                background: #f3f6f4;
                color: #2e7d32;
                font-weight: 600;
            }
            .eudr-table tbody tr:nth-child(even) { background: #fafafa; }

            .eudr-num { text-align: right; white-space: nowrap; }

            .eudr-inline-table th {
                width: 38%;
                background: #f7f9f7;
                font-weight: 600;
            }

            /* prevent awkward row splits in PDF */
            .eudr-row { page-break-inside: avoid; }
            .eudr-pre {
                white-space: pre-wrap;
                background: #f8f8f8;
                border: 1px solid #ddd;
                padding: 8px;
                border-radius: 3px;
                margin-top: 6px;
            }

            /* simple grid since bootstrap may vary in reports */
            .grid { display: table; width: 100%; table-layout: fixed; }
            .col { display: table-cell; vertical-align: top; }
            .col-6 { width: 50%; padding-right: 8px; }
            .col-6 + .col-6 { padding-right: 0; padding-left: 8px; }

            .muted { color: #666; }

            .eudr-subtable {
                width: 100%;
                border-collapse: collapse;
                margin-top: 6px;
            }
            .eudr-subtable th, .eudr-subtable td {
                border: 1px solid #bbb;
                padding: 4px 6px;
                font-size: 11px;
                vertical-align: top;
            }
            .eudr-subtable thead th {
                background: #f3f6f4;
                color: #2e7d32;
            }
        </style>

        <t t-foreach="docs" t-as="doc">
            <t t-set="field_info" t-value="doc.fields_get(['eudr_company_type', 'activity_type'])"/>
            <t t-set="company_selection" t-value="dict(field_info.get('eudr_company_type', {}).get('selection', []))"/>
            <t t-set="activity_selection" t-value="dict(field_info.get('activity_type', {}).get('selection', []))"/>

            <div class="page eudr-report">
                <div class="grid">
                    <div class="col col-6">
                        <h2>EUDR Declaration</h2>
                        <div class="eudr-card eudr-meta">
                            <p>
                                <span class="muted">Reference:</span>
                                <span t-esc="doc.name or doc.display_name"/>
                            </p>
                            <p>
                                <span class="muted">Partner:</span>
                                <span t-esc="doc.partner_id.display_name or '-'"/>
                            </p>
                            <p>
                                <span class="muted">Creation Date:</span>
                                <span t-field="doc.datestamp"/>
                            </p>
                            <p>
                                <span class="muted">Company Type:</span>
                                <span t-esc="company_selection.get(doc.eudr_company_type, '-') if doc.eudr_company_type else '-'"/>
                            </p>
                            <p>
                                <span class="muted">Activity:</span>
                                <span t-esc="activity_selection.get(doc.activity_type, '-') if doc.activity_type else '-'"/>
                            </p>
                            <p>
                                <span class="muted">DDS Identifier:</span>
                                <span t-esc="doc.dds_identifier or '-'"/>
                            </p>
                        </div>
                    </div>

                    <div class="col col-6">
                        <table class="eudr-table eudr-inline-table eudr-row">
                            <tbody>
                                <tr>
                                    <th>Operator</th>
                                    <td><span t-esc="doc.operator_name or '-'"/></td>
                                </tr>
                                <tr>
                                    <th>Product</th>
                                    <td>
                                        <t t-if="doc.product_id">
                                            <span t-esc="doc.product_id.display_name"/>
                                        </t>
                                        <t t-else="">
                                            <span t-esc="doc.product_description or '-'"/>
                                        </t>
                                    </td>
                                </tr>
                                <tr>
                                    <th>HS Code</th>
                                    <td><span t-esc="doc.hs_code or '-'"/></td>
                                </tr>
                                <tr>
                                    <th>Net Mass (Kg)</th>
                                    <td class="eudr-num"><span t-field="doc.net_mass_kg"/></td>
                                </tr>
                                <tr>
                                    <th>Total Area (Ha)</th>
                                    <td class="eudr-num"><span t-esc="doc.area_ha_display or '-'"/></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3>Declaration Lines</h3>
                <table class="eudr-table table-bordered o_main_table">
<!--                    <colgroup>-->
<!--                        <col style="width:4%"/>-->
<!--                        <col style="width:18%"/>-->
<!--                        <col style="width:9%"/>-->
<!--                        <col style="width:12%"/>-->
<!--                        <col style="width:12%"/>-->
<!--                        <col style="width:8%"/>-->
<!--                        <col style="width:8%"/>-->
<!--                        <col style="width:9%"/>-->
<!--                        <col style="width:10%"/>-->
<!--                        <col style="width:10%"/>-->
<!--                        <col style="width:12%"/>-->
<!--                    </colgroup>-->
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Farmer / Farm</th>
                            <th>Country</th>
                            <th>Region</th>
                            <th>Municipality</th>
                            <th>Area (Ha)</th>
                            <th>Geo Type</th>
                            <th>External Status</th>
                            <th>Deforestation Provider</th>
                            <th>Deforestation Alerts</th>
                            <th>Deforestation Area (Ha)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-if="not doc.line_ids">
                            <tr class="eudr-row">
                                <td colspan="11" style="text-align:center;">No lines available</td>
                            </tr>
                        </t>

                        <t t-foreach="enumerate(doc.line_ids)" t-as="it">
                            <tr class="eudr-row">
                                <td class="eudr-num"><span t-esc="it[0] + 1"/></td>
                                <td>
                                    <div><span t-esc="it[1].farmer_name or it[1].name or '-'"/></div>
                                    <div t-if="it[1].farm_name" class="muted">(<span t-esc="it[1].farm_name"/>)</div>
                                </td>
                                <td><span t-esc="it[1].country or '-'"/></td>
                                <td><span t-esc="it[1].region or '-'"/></td>
                                <td><span t-esc="it[1].municipality or '-'"/></td>
                                <td class="eudr-num"><span t-esc="it[1].area_ha or '-'"/></td>
                                <td><span t-esc="it[1].geo_type or '-'"/></td>
                                <td><span t-esc="it[1].external_status or '-'"/></td>
                                <td><span t-esc="it[1].defor_provider or '-'"/></td>
                                <td class="eudr-num"><span t-esc="it[1].defor_alerts if it[1].defor_alerts is not None else '-'"/></td>
                                <td class="eudr-num"><span t-esc="it[1].defor_area_ha if it[1].defor_area_ha is not None else '-'"/></td>
                            </tr>

                            <tr t-if="it[1].defor_details_json" class="eudr-row">
                                <td></td>
                                <td colspan="10">
                                    <div class="muted">Deforestation Details:</div>
                                    <pre class="eudr-pre" t-esc="it[1].defor_details_json"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <t t-if="doc.extra_info">
                    <h3>Additional Information</h3>
                    <div class="eudr-card">
                        <p t-esc="doc.extra_info"/>
                    </div>
                </t>

                <h3>Declaration Lines &amp; Alerts Overview</h3>
                <table class="eudr-table table-bordered o_main_table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Farmer / Farm</th>
                            <th>Country</th>
                            <th>Region</th>
                            <th>Municipality</th>
                            <th>Area (Ha)</th>
                            <th>Geo Type</th>
                            <th>External Status</th>
                            <th>Deforestation Provider</th>
                            <th>Deforestation Alerts</th>
                            <th>Deforestation Area (Ha)</th>
                            <th>Related Alerts</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-if="not doc.line_ids">
                            <tr class="eudr-row">
                                <td colspan="12" style="text-align:center;">No lines available</td>
                            </tr>
                        </t>
                        <t t-foreach="enumerate(doc.line_ids)" t-as="line_iter">
                            <t t-set="line" t-value="line_iter[1]"/>
                            <tr class="eudr-row">
                                <td class="eudr-num"><span t-esc="line_iter[0] + 1"/></td>
                                <td>
                                    <div><span t-esc="line.farmer_name or line.name or '-'"/></div>
                                    <div t-if="line.farm_name" class="muted">(<span t-esc="line.farm_name"/>)</div>
                                </td>
                                <td><span t-esc="line.country or '-'"/></td>
                                <td><span t-esc="line.region or '-'"/></td>
                                <td><span t-esc="line.municipality or '-'"/></td>
                                <td class="eudr-num"><span t-esc="line.area_ha or '-'"/></td>
                                <td><span t-esc="line.geo_type or '-'"/></td>
                                <td><span t-esc="line.external_status or '-'"/></td>
                                <td><span t-esc="line.defor_provider or '-'"/></td>
                                <td class="eudr-num"><span t-esc="line.defor_alerts if line.defor_alerts is not None else '-'"/></td>
                                <td class="eudr-num"><span t-esc="line.defor_area_ha if line.defor_area_ha is not None else '-'"/></td>
                                <td>
                                    <t t-if="line.alert_ids">
                                        <table class="eudr-subtable">
                                            <thead>
                                                <tr>
                                                    <th>Provider</th>
                                                    <th>Identifier</th>
                                                    <th>Date</th>
                                                    <th>Risk Level</th>
                                                    <th>Confidence</th>
                                                    <th>Area (Ha)</th>
                                                    <th>Coordinates</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="line.alert_ids" t-as="alert">
                                                    <tr>
                                                        <td><span t-esc="alert.provider or '-'"/></td>
                                                        <td><span t-esc="alert.alert_identifier or '-'"/></td>
                                                        <td>
                                                            <t t-if="alert.alert_date">
                                                                <span t-field="alert.alert_date"/>
                                                            </t>
                                                            <t t-elif="alert.alert_date_raw">
                                                                <span t-esc="alert.alert_date_raw"/>
                                                            </t>
                                                            <t t-else="">
                                                                <span>-</span>
                                                            </t>
                                                        </td>
                                                        <td><span t-esc="alert.risk_level or '-'"/></td>
                                                        <td><span t-esc="alert.confidence or '-'"/></td>
                                                        <td class="eudr-num"><span t-esc="alert.area_ha if alert.area_ha not in (None, False) else '-'"/></td>
                                                        <td>
                                                            <span t-esc="('%0.5f, %0.5f' % (alert.latitude, alert.longitude)) if (alert.latitude not in (None, False) and alert.longitude not in (None, False)) else '-'"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <span class="muted">No alerts</span>
                                    </t>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>
    </t>
</template>


        <report
            id="action_report_eudr_declaration"
            model="eudr.declaration"
            string="EUDR Declaration"
            report_type="qweb-pdf"
            name="planetio.report_eudr_declaration_document"
            file="planetio.report_eudr_declaration_document"
            print_report_name="'EUDR Declaration - %s' % (object.name or object.id)"
        />
    </data>
</odoo>
