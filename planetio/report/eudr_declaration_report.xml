<odoo>
  <data>

    <template id="report_eudr_declaration_document">
      <t t-call="web.html_container">
        <!-- Styles tuned for wkhtmltopdf (no '<' in comments) -->
        <style type="text/css">
          .eudr-report * { box-sizing: border-box; }
          .eudr-report { font-size: 13px; color: #1d1d1d; line-height: 1.45; }

          /* Headings */
          .eudr-report h2, .eudr-report h3 {
            color: #2e7d32;
            margin: 0 0 10px 0;
            line-height: 1.25;
          }
          .eudr-report h2 { font-size: 22px; }
          .eudr-report h3 { font-size: 18px; margin-top: 20px; }

          .eudr-meta { margin-bottom: 12px; }
          .eudr-meta p { margin: 3px 0; }

          .eudr-card {
            border: 1px solid #cfe8d2;
            border-radius: 4px;
            padding: 10px;
            background: #f9fbf9;
          }

          /* Badge uppercase and larger */
          .eudr-report .badge{
            display: inline-block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .35px;
            padding: 3px 8px;
            border: 1px solid #c8e6c9;
            border-radius: 12px;
            margin-right: 6px;
            background: #f6fff7;
            line-height: 1;
          }

          /* Main tables */
          .eudr-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0 18px 0;
            table-layout: auto;           /* let columns breathe */
          }
          .eudr-table th, .eudr-table td {
            border: 1px solid #cfe8d2;
            padding: 7px 9px;
            vertical-align: top;
            background-clip: padding-box;
            /* prevent overflow and vertical text */
            overflow-wrap: anywhere;
            word-wrap: break-word;        /* legacy */
            word-break: normal;
          }
          .eudr-table thead th {
            background: #e8f5e9;
            color: #1b5e20;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .3px;
            font-size: 11px;
            line-height: 1.3;
            white-space: normal;          /* allow wrapping */
          }
          .eudr-table tbody tr:nth-child(even) { background: #fbfdfb; }

          /* Inline table (right card) */
          .eudr-inline-table th {
            width: 42%;
            background: #f3f9f4;
            font-weight: 600;
            color: #1b5e20;
          }

          /* Numeric / nowrap cells */
          .eudr-num    { text-align: right; white-space: nowrap; }
          .eudr-nowrap { white-space: nowrap; }
          .wrap        { white-space: normal; }

          /* Layout grid */
          .grid { display: table; width: 100%; table-layout: fixed; }
          .col { display: table-cell; vertical-align: top; }
          .col-6 { width: 50%; padding-right: 10px; }
          .col-6 + .col-6 { padding-right: 0; padding-left: 10px; }

          .muted { color: #666; }

          /* Subtable (Related Alerts) with lighter borders */
          .eudr-subtable {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
            margin-top: 6px;
          }
          .eudr-subtable th, .eudr-subtable td {
            border-bottom: 1px solid #cfe8d2; /* only horizontal lines */
            padding: 6px 8px;
            font-size: 12px;
            vertical-align: top;
            overflow-wrap: anywhere;
            word-wrap: break-word;
            word-break: normal;
          }
          .eudr-subtable thead th {
            background: #eef7f0;
            color: #1b5e20;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .25px;
            font-size: 11px;
            line-height: 1.3;
            white-space: normal;
          }

          .eudr-row { page-break-inside: avoid; }
          .page-break { page-break-before: always; }
        </style>

        <t t-foreach="docs" t-as="doc">
          <t t-set="field_info" t-value="doc.fields_get(['eudr_company_type', 'activity_type'])"/>
          <t t-set="company_selection" t-value="dict(field_info.get('eudr_company_type', {}).get('selection', []))"/>
          <t t-set="activity_selection" t-value="dict(field_info.get('activity_type', {}).get('selection', []))"/>

          <div class="page eudr-report">
            <div class="grid">
              <div class="col col-6">
                <h2>EUDR Declaration</h2>
                <div class="eudr-card eudr-meta">
                  <p>
                    <span class="muted">Reference:</span>
                    <span class="badge" t-esc="doc.name or doc.display_name"/>
                  </p>
                  <p>
                    <span class="muted">Partner:</span>
                    <span t-esc="doc.partner_id.display_name or '-'"/>
                  </p>
                  <p>
                    <span class="muted">Creation Date:</span>
                    <span t-field="doc.datestamp"/>
                  </p>
                  <p>
                    <span class="muted">Company Type:</span>
                    <span t-esc="company_selection.get(doc.eudr_company_type, '-') if doc.eudr_company_type else '-'"/>
                  </p>
                  <p>
                    <span class="muted">Activity:</span>
                    <span t-esc="activity_selection.get(doc.activity_type, '-') if doc.activity_type else '-'"/>
                  </p>
                  <p>
                    <span class="muted">DDS Identifier:</span>
                    <span class="badge" t-esc="doc.dds_identifier or '-'"/>
                  </p>
                </div>
              </div>

              <div class="col col-6">
                <table class="eudr-table eudr-inline-table eudr-row">
                  <thead>
                    <tr>
                      <th>Field</th>
                      <th>Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <th>Operator</th>
                      <td><span t-esc="doc.operator_name or '-'"/></td>
                    </tr>
                    <tr>
                      <th>Product</th>
                      <td>
                        <t t-if="doc.product_id">
                          <span t-esc="doc.product_id.display_name"/>
                        </t>
                        <t t-else="">
                          <span t-esc="doc.product_description or '-'"/>
                        </t>
                      </td>
                    </tr>
                    <tr>
                      <th>HS Code</th>
                      <td><span t-esc="doc.hs_code_id.code or '-'"/></td>
                    </tr>
                    <tr>
                      <th>Product Species</th>
                      <td>
                        <t t-if="doc.product_species_ids">
                          <ul class="list-unstyled mb-0">
                            <li t-foreach="doc.product_species_ids" t-as="species">
                              <span t-esc="species.name"/>
                              <t t-if="species.scientific_name">
                                (<span t-esc="species.scientific_name"/>)
                              </t>
                            </li>
                          </ul>
                        </t>
                        <t t-else="">
                          <span>-</span>
                        </t>
                      </td>
                    </tr>
                    <tr>
                      <th>Net Mass (Kg)</th>
                      <td class="eudr-num"><span t-field="doc.net_mass_kg"/></td>
                    </tr>
                    <tr>
                      <th>Total Area (Ha)</th>
                      <td class="eudr-num"><span t-esc="doc.area_ha_display or '-'"/></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <h3>Declaration Lines</h3>
            <table class="eudr-table o_main_table eudr-row">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Farmer / Farm</th>
                  <th>Country</th>
                  <th>Region</th>
                  <th>Municipality</th>
                  <th class="eudr-nowrap">Area (Ha)</th>
                  <th class="eudr-nowrap">Geo Type</th>
                  <th>External Status</th>
                  <th>Defor. Provider</th>
                  <th class="eudr-nowrap">Alerts</th>
                  <th class="eudr-nowrap">Defor. Area (Ha)</th>
                </tr>
              </thead>
              <tbody>
                <t t-if="not doc.line_ids">
                  <tr class="eudr-row">
                    <td colspan="11" style="text-align:center;">No lines available</td>
                  </tr>
                </t>

                <t t-foreach="enumerate(doc.line_ids)" t-as="it">
                  <tr class="eudr-row">
                    <td class="eudr-num"><span t-esc="it[0] + 1"/></td>
                    <td>
                      <div><span t-esc="it[1].farmer_name or it[1].name or '-'"/></div>
                      <div t-if="it[1].farm_name" class="muted">(<span t-esc="it[1].farm_name"/>)</div>
                    </td>
                    <td><span t-esc="it[1].country or '-'"/></td>
                    <td><span t-esc="it[1].region or '-'"/></td>
                    <td><span t-esc="it[1].municipality or '-'"/></td>
                    <td class="eudr-num"><span t-esc="it[1].area_ha or '-'"/></td>
                    <td><span t-esc="it[1].geo_type or '-'"/></td>
                    <td><span t-esc="it[1].external_status or '-'"/></td>
                    <td><span t-esc="it[1].defor_provider or '-'"/></td>
                    <td class="eudr-num"><span t-esc="it[1].defor_alerts if it[1].defor_alerts is not None else '-'"/></td>
                    <td class="eudr-num"><span t-esc="it[1].defor_area_ha if it[1].defor_area_ha is not None else '-'"/></td>
                  </tr>

                  <!-- JSON pretty print with safe fallback -->
                  <tr t-if="it[1].defor_details_json" class="eudr-row">
                    <td></td>
                    <td colspan="10">
                      <div class="muted">Deforestation Details:</div>
                        <t t-set="_raw" t-value="it[1].defor_details_json or ''"/>
                        <t t-set="_pp"
                           t-value="(_raw or '').strip()
                                    .replace(',{', ',\n{')
                                    .replace(',[', ',\n[')
                                    .replace('{', '{\n')
                                    .replace('}', '\n}')
                                    .replace('[', '[\n')
                                    .replace(']', '\n]')
                                    .replace(':', ': ')"/>
                        <pre class="eudr-pre"><t t-raw="_pp.replace('&quot;', '')"/></pre>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>

            <t t-if="doc.extra_info">
              <h3>Additional Information</h3>
              <div class="eudr-card">
                <p t-esc="doc.extra_info"/>
              </div>
            </t>

            <div class="page-break"></div>

            <h3>Declaration Lines &amp; Alerts Overview</h3>
            <table class="eudr-table o_main_table eudr-row">
              <!-- No "Related Alerts" column; details on their own row -->
              <colgroup>
                <col style="width:4%"/>
                <col style="width:26%"/>
                <col style="width:9%"/>
                <col style="width:10%"/>
                <col style="width:13%"/>
                <col style="width:8%"/>
                <col style="width:8%"/>
                <col style="width:10%"/>
                <col style="width:8%"/>
                <col style="width:4%"/>
                <col style="width:4%"/>
              </colgroup>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Farmer / Farm</th>
                  <th>Country</th>
                  <th>Region</th>
                  <th>Municipality</th>
                  <th class="eudr-nowrap">Area (Ha)</th>
                  <th class="eudr-nowrap">Geo Type</th>
                  <th>External Status</th>
                  <th class="eudr-nowrap">Provider</th>
                  <th class="eudr-nowrap">Alerts</th>
                  <th class="eudr-nowrap">Defor. Area</th>
                </tr>
              </thead>
              <tbody>
                <t t-if="not doc.line_ids">
                  <tr class="eudr-row">
                    <td colspan="11" style="text-align:center;">No lines available</td>
                  </tr>
                </t>

                <t t-foreach="enumerate(doc.line_ids)" t-as="line_iter">
                  <t t-set="line" t-value="line_iter[1]"/>
                  <tr class="eudr-row">
                    <td class="eudr-num"><span t-esc="line_iter[0] + 1"/></td>
                    <td>
                      <div><span t-esc="line.farmer_name or line.name or '-'"/></div>
                      <div t-if="line.farm_name" class="muted">(<span t-esc="line.farm_name"/>)</div>
                    </td>
                    <td><span t-esc="line.country or '-'"/></td>
                    <td><span t-esc="line.region or '-'"/></td>
                    <td><span t-esc="line.municipality or '-'"/></td>
                    <td class="eudr-num"><span t-esc="line.area_ha or '-'"/></td>
                    <td><span t-esc="line.geo_type or '-'"/></td>
                    <td><span t-esc="line.external_status or '-'"/></td>
                    <td><span t-esc="line.defor_provider or '-'"/></td>
                    <td class="eudr-num"><span t-esc="line.defor_alerts if line.defor_alerts is not None else '-'"/></td>
                    <td class="eudr-num"><span t-esc="line.defor_area_ha if line.defor_area_ha is not None else '-'"/></td>
                  </tr>

                  <!-- Related Alerts: full width row, lighter borders -->
                  <tr t-if="line.alert_ids" class="eudr-row">
                    <td></td>
                    <td colspan="10">
                      <table class="eudr-subtable">
                        <thead>
                          <tr>
                            <th>Provider</th>
                            <th>Identifier</th>
                            <th>Date</th>
                            <th>Risk</th>
                            <th>Confidence</th>
                            <th class="eudr-nowrap">Area (Ha)</th>
                            <th>Coordinates</th>
                          </tr>
                        </thead>
                        <tbody>
                          <t t-foreach="line.alert_ids" t-as="alert">
                            <tr>
                              <td><span t-esc="alert.provider or '-'"/></td>
                              <td><span class="badge" t-esc="alert.alert_identifier or '-'"/></td>
                              <td>
                                <t t-if="alert.alert_date">
                                  <span t-field="alert.alert_date"/>
                                </t>
                                <t t-elif="alert.alert_date_raw">
                                  <span t-esc="alert.alert_date_raw"/>
                                </t>
                                <t t-else=""><span>-</span></t>
                              </td>
                              <td><span t-esc="alert.risk_level or '-'"/></td>
                              <td><span t-esc="alert.confidence or '-'"/></td>
                              <td class="eudr-num"><span t-esc="alert.area_ha if alert.area_ha not in (None, False) else '-'"/></td>
                              <td>
                                <t t-if="alert.latitude not in (None, False) and alert.longitude not in (None, False)">
                                  <span t-esc="'%0.4f, %0.4f' % (alert.latitude, alert.longitude)"/>
                                </t>
                                <t t-else=""><span>-</span></t>
                              </td>
                            </tr>
                          </t>
                        </tbody>
                      </table>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>
          </div>
        </t>
      </t>
    </template>

    <report
      id="action_report_eudr_declaration"
      model="eudr.declaration"
      string="EUDR Declaration"
      report_type="qweb-pdf"
      name="planetio.report_eudr_declaration_document"
      file="planetio.report_eudr_declaration_document"
      print_report_name="'EUDR Declaration - %s' % (object.name or object.id)"
    />
  </data>
</odoo>
